version: '3.8'

services:
  cloudflared:
    # ğŸ’¥ å…³é”®ä¿®æ”¹ 1: ä½¿ç”¨ 'build' ä»£æ›¿ 'image'
    # Docker Compose å°†è‡ªåŠ¨æ„å»ºåŒç›®å½•ä¸‹çš„ Dockerfile
    build:
      context: . 
      dockerfile: Dockerfile
      # å»ºè®®ä¸ºæ„å»ºçš„é•œåƒæŒ‡å®šä¸€ä¸ªåç§°ï¼Œæ–¹ä¾¿ç®¡ç†
    image: cloudflared_custom:latest 
    container_name: cloudflared
    restart: always  # å®¹å™¨å¤±è´¥æ—¶è‡ªåŠ¨é‡å¯
    network_mode: host  # å…è®¸å®¹å™¨è®¿é—®å®¿ä¸»æœºç½‘ç»œ
    environment:
      - HTTP_PROXY=http://127.0.0.1:7890  # è®¾ç½® HTTP ä»£ç†
      - HTTPS_PROXY=http://127.0.0.1:7890  # è®¾ç½® HTTPS ä»£ç†
      - NO_PROXY=localhost,127.0.0.1  # ä¸ä½¿ç”¨ä»£ç†çš„åœ°å€
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - ./logs:/var/log/cloudflared  # å°†æ—¥å¿—ç›®å½•æŒä¹…åŒ–åˆ°å®¿ä¸»æœº
    command: 
      [
        "--loglevel", "info", 
        "--logfile", "/var/log/cloudflared/cloudflared.log",
        "--metrics", "localhost:2000",
        "tunnel", 
        "--no-autoupdate",
        "run",
        "--token", "eyJhIjoiZDIwODZkMjEzMzJiNDY3ZGRhZjhkM2UwMWZiNTJjZDUiLCJ0IjoiMGQwZTYwYzUtZWUyMi00YjE4LWExYjgtYTY4NDg1YmRlNDUzIiwicyI6Ik1tVTBPV1kwWkRndE56azVNUzAwT0RBNUxUa3lOMk10T1dWaE5EVmhORFV5TTJNMCJ9"
      ]

    # å¥åº·æ£€æŸ¥é…ç½®
    healthcheck:
      test: [
        "CMD-SHELL",
        "curl -s http://localhost:2000/metrics | grep -E '^cloudflared_tunnel_ha_connections [1-9]'"
      ]
      interval: 30s  # æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
      retries: 3  # å¦‚æœå¤±è´¥3æ¬¡ï¼ŒDocker ä¼šé‡å¯å®¹å™¨
      start_period: 10s  # å®¹å™¨å¯åŠ¨åï¼Œå¥åº·æ£€æŸ¥å°†åœ¨10ç§’åå¼€å§‹
      timeout: 5s  # æ¯æ¬¡æ£€æŸ¥çš„è¶…æ—¶æ—¶é—´

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
