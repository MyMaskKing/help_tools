version: '3.8'

services:
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: always  # 容器失败时自动重启
    network_mode: host  # 允许容器访问宿主机网络
    environment:
      - HTTP_PROXY=http://127.0.0.1:7890  # 设置 HTTP 代理
      - HTTPS_PROXY=http://127.0.0.1:7890  # 设置 HTTPS 代理
      - NO_PROXY=localhost,127.0.0.1  # 不使用代理的地址
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - ./logs:/var/log/cloudflared  # 将日志目录持久化到宿主机
    command: 
      [
        "--loglevel", "info", 
        "--logfile", "/var/log/cloudflared/cloudflared.log",
        "--metrics", "localhost:2000",
        "tunnel", 
        "--no-autoupdate",
        "run",
        "--token", "eyJhIjoiZDIwODZkMjEzMzJiNDY3ZGRhZjhkM2UwMWZiNTJjZDUiLCJ0IjoiMGQwZTYwYzUtZWUyMi00YjE4LWExYjgtYTY4NDg1YmRlNDUzIiwicyI6Ik1tVTBPV1kwWkRndE56azVNUzAwT0RBNUxUa3lOMk10T1dWaE5EVmhORFV5TTJNMCJ9"
      ]

    # 健康检查配置
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:2000/metrics | grep -E '^cloudflared_tunnel_ha_connections [1-9]'"]
      interval: 30s  # 每30秒检查一次
      retries: 3  # 如果失败3次，Docker 会重启容器
      start_period: 10s  # 容器启动后，健康检查将在10秒后开始
      timeout: 5s  # 每次检查的超时时间

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
